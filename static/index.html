<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Management Interface</title>
    <link rel='stylesheet' type='text/css' href='static/styles.css'>
</head>
<body>
		<div class="container">
        <div class="sidebar">
            <button class="nav-item" onclick="createNewTask()">New Task</button>
            <ul class="task-history" id="taskHistory"></ul>
        </div>

        <div class="header">
            <div class="model-info">
                <h2>Current Task: <span id="currentTask">None</span></h2>
                <p>Model: <span id="selectedModel">None</span></p>
                <button class="status-badge" id="statusBadge" onclick="updateTaskStatus()" disabled>Idle</button>
            </div>
        </div>

        <div class="workspace">
            <div id="workspaceContent" class="workspace-content">
                <p>Select a task from the history or create a new one to begin.</p>
            </div>
        </div>
    </div>
    <!-- New Task Modal -->
    <div id="newTaskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create New Task</h2>
            </div>
            <form id="newTaskForm" onsubmit="handleNewTaskSubmit(event)">
                <div class="form-group">
                    <label for="taskName">Task Name</label>
                    <input 
                        type="text" 
                        id="taskName" 
                        name="taskName" 
                        required
                    >
                </div>
                <div class="form-group">
                    <label for="modelType">Model</label>
                    <select id="modelType" name="modelType" required>
                        <option value="">Select a model</option>
                        <option value="gpt-4">GPT-4</option>
                        <option value="gpt-3.5">GPT-3.5</option>
                        <option value="claude">Claude</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button 
                        type="button" 
                        class="button button-secondary"
                        onclick="closeNewTaskModal()"
                    >
                        Cancel
                    </button>
                    <button type="submit" class="button">Create Task</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Function to handle instruction submission
        async function handleInstructionSubmit(event) {
            event.preventDefault();
            const instruction = event.target.instruction.value;
            console.log('Sending instruction:', instruction);

            try {
                const response = await fetch('/instruction_input', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ instruction })
                });

                if (response.ok) {
                    console.log('Instruction submitted successfully');
                    event.target.reset();
                } else {
                    console.error('Failed to submit instruction');
                }
            } catch (error) {
                console.error('Error submitting instruction:', error);
            }
        }

        // Function to handle new task creation
        async function handleNewTaskSubmit(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const taskData = Object.fromEntries(formData);

            try {
                const response = await fetch('/new_task', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(taskData)
                });

                if (response.ok) {
                    console.log('New task created:', taskData);
                    closeNewTaskModal();
                    loadTaskHistory();
                    event.target.reset();
                } else {
                    console.error('Failed to create new task');
                }
            } catch (error) {
                console.error('Error creating new task:', error);
            }
        }

        function createNewTask() {
            document.getElementById('newTaskModal').classList.add('active');
        }

        function closeNewTaskModal() {
            document.getElementById('newTaskModal').classList.remove('active');
        }
        
       	async function loadTaskHistory() {
            try {
                const response = await fetch('/poll_task_history');
                const tasks = await response.json();

                const taskHistoryElement = document.getElementById('taskHistory');
                taskHistoryElement.innerHTML = '';

                tasks.forEach(task => {
                    const newTaskElement = document.createElement('li');
                    newTaskElement.classList.add('task-history-item');
                    newTaskElement.innerHTML = `
                        <div>
                            <span class="task-name">${task.taskTitle}</span>
                            <button class="select-button" onclick="selectTask(${task.taskId})">Select</button>
                        </div>
                        <div class="delete-button" onclick="deleteTask('${task.taskTitle}')">
                            Delete
                        </div>
                    `;
                    taskHistoryElement.appendChild(newTaskElement);
                });
            } catch (error) {
                console.error('Error loading task history:', error);
            }
        } 

				async function selectTask(taskId) {

            try {
                const response = await fetch('/poll_workspace_update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({idtask: taskId.toString()})
                });

                const task = await response.json();

                // Update model info
                document.getElementById('selectedModel').textContent = task.taskModelType || 'None';
                document.getElementById('currentTask').textContent = task.taskName;
                const statusBadge = document.getElementById('statusBadge');
                statusBadge.textContent = task.status || 'Idle';
                statusBadge.disabled = false;

                // Update workspace content
                const workspaceContent = document.getElementById('workspaceContent');
                workspaceContent.innerHTML = `
                    <h3>Task Details</h3>
                    <p><strong>Task Name:</strong> ${task.taskName}</p>
                    <p><strong>Model:</strong> ${task.taskModelType}</p>
                    <p><strong>Status:</strong> ${task.status}</p>
                    <form class="instruction-form" onsubmit="handleInstructionSubmit(event, '${task.taskName}')">
                        <input 
                            type="text" 
                            class="instruction-input" 
                            placeholder="Enter your instruction here..."
                            name="instruction"
                            required
                        >
                        <button type="submit" class="button">Send</button>
                    </form>
                `;
            } catch (error) {
                console.error('Error loading task workspace');
            }
        }

        // Function to delete a task
        async function deleteTask(taskData) {
            try {
                const response = await fetch('/delete_task', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(taskData)
                });

                if (response.ok) {
                    console.log('Task deleted:', taskData.taskName);
                    removeTaskFromHistory(taskData.taskName);
                } else {
                    console.error('Failed to delete task');
                }
            } catch (error) {
                console.error('Error deleting task:', error);
            }
        }

        // Function to remove a task from the task history
        function removeTaskFromHistory(taskName) {
            const taskHistoryElement = document.getElementById('taskHistory');
            const taskItems = taskHistoryElement.getElementsByClassName('task-history-item');

            for (let i = 0; i < taskItems.length; i++) {
                if (taskItems[i].textContent.includes(taskName)) {
                    taskHistoryElement.removeChild(taskItems[i]);
                    break;
                }
            }
        }

        // Initial load of task history
        loadTaskHistory();

    </script>
</body>
</html>
